<% content_for :title, t("ui.show.page_title") %>

<% content_for :head do %>
  <script>
    document.addEventListener("turbo:load", function() {
      const autoSubmit = document.querySelector("[data-auto-submit]");
      const clocks = Array.from(document.querySelectorAll("[data-deadline]"))
        .map((clock) => ({ element: clock, deadline: Number(clock.dataset.deadline) }))
        .filter((entry) => Number.isFinite(entry.deadline));
      if (clocks.length === 0) return;

      function format(seconds) {
        const minutes = Math.floor(seconds / 60).toString().padStart(2, "0");
        const secs = (seconds % 60).toString().padStart(2, "0");
        return `${minutes}:${secs}`;
      }

      let submitted = false;
      let intervalId = null;

      function tick() {
        clocks.forEach(function(entry) {
          const left = Math.max(0, Math.floor((entry.deadline - Date.now()) / 1000));
          entry.element.textContent = format(left);
          if (left === 0 && !submitted && autoSubmit) {
            submitted = true;
            autoSubmit.click();
          }
        });

        if (clocks.every((entry) => entry.element.textContent === "00:00") && intervalId) {
          clearInterval(intervalId);
        }
      }

      tick();
      intervalId = setInterval(tick, 250);
    });
  </script>
<% end %>

<header class="exam-header">
  <div class="exam-header__top">
    <%= link_to t("ui.show.cancel_exam"), cancel_exam_attempt_path(@exam_attempt),
      class: "exam-header__cancel",
      data: { turbo_method: :patch, turbo_confirm: t("ui.show.cancel_exam_confirm") } %>
  </div>
  <h1><%= t("ui.show.question_progress", current: @current_item.position, total: @questions_total) %></h1>
  <p>
    <%= t("ui.show.completed_label") %>: <strong><%= @answered_questions_count %></strong> / <strong><%= @questions_total %></strong>
    •
    <%= t("ui.show.language_label") %>: <strong><%= @exam_attempt.locale.upcase %></strong>
    •
    <%= @current_item.question.scope_basic? ? t("ui.common.scope_basic_question") : t("ui.common.scope_specialist_question") %>
  </p>
</header>

<section>
  <p>
    <%= t("ui.show.question_timer_label") %>:
    <strong data-deadline="<%= (Time.current + @question_time_left_seconds.seconds).to_i * 1000 %>">--:--</strong>
    (<%= t("ui.show.question_limit", seconds: @question_time_limit_seconds) %>)
  </p>
  <p>
    <%= t("ui.show.exam_timer_label") %>:
    <strong data-deadline="<%= (Time.current + @exam_time_left_seconds.seconds).to_i * 1000 %>">--:--</strong>
  </p>
</section>

<%= form_with url: exam_attempt_path(@exam_attempt), method: :patch do %>
  <% item = @current_item %>
  <% question = item.question %>

  <%= hidden_field_tag :item_id, item.id %>

  <article>
    <p>
      <%= t("ui.show.question_label") %> <strong><%= item.position %></strong>
      •
      <%= question.scope == "basic" ? t("ui.common.scope_basic") : t("ui.common.scope_specialist") %>
      •
      <%= item.points_possible %> <%= t("ui.common.points_short") %>
    </p>

    <h2><%= question.stem_for(@exam_attempt.locale) %></h2>

    <%= render "media", question: question, item: item %>

    <fieldset>
      <legend><%= t("ui.show.choose_answer") %></legend>

      <% if question.answer_mode_yes_no? %>
        <% yes_no_labels = case @exam_attempt.locale
                          when "en" then [["T", "Yes"], ["N", "No"]]
                          when "de" then [["T", "Ja"], ["N", "Nein"]]
                          when "ua" then [["T", "Так"], ["N", "Ні"]]
                          else [["T", "Tak"], ["N", "Nie"]]
                          end %>
        <% yes_no_labels.each do |key, label| %>
          <label class="answer-option <%= key == "T" ? "answer-option--yes" : "answer-option--no" %>">
            <%= radio_button_tag :answer, key, false %>
            <span><%= label %></span>
          </label>
          <br>
        <% end %>
      <% else %>
        <% question.question_options.sort_by(&:position).each do |option| %>
          <label class="answer-option">
            <%= radio_button_tag :answer, option.key, false %>
            <span><strong><%= option.key %>.</strong> <%= option.text_for(@exam_attempt.locale) %></span>
          </label>
          <br>
        <% end %>
      <% end %>
    </fieldset>
  </article>

  <p class="question-submit">
    <button type="submit" data-auto-submit="true">
      <%= @last_question ? t("ui.show.finish_exam") : t("ui.show.next_question") %>
    </button>
  </p>
<% end %>
