<% content_for :title, t("ui.result.page_title", id: @exam_attempt.uuid) %>

<% status_label =
  if @exam_attempt.status_cancelled?
    t("ui.result.status.cancelled")
  elsif @exam_attempt.passed?
    t("ui.result.status.passed")
  else
    t("ui.result.status.failed")
  end %>
<% completion_mode =
  if @exam_attempt.status_cancelled?
    t("ui.result.completion.cancelled")
  elsif @exam_attempt.status_expired?
    t("ui.result.completion.expired")
  else
    t("ui.result.completion.completed")
  end %>

<header>
  <p><%= t("ui.result.kicker") %></p>
  <h1>
    <%= @exam_attempt.score || 0 %> / <%= @exam_attempt.max_score %> <%= t("ui.common.points_short") %>
  </h1>
  <p>
    <%= t("ui.result.pass_threshold_label") %>: <strong><%= @exam_attempt.exam_blueprint.pass_score %> <%= t("ui.common.points_short") %></strong>
    • <%= t("ui.result.language_label") %>: <strong><%= @exam_attempt.locale.upcase %></strong>
    • <%= t("ui.result.status_label") %>: <strong><%= status_label %></strong>
    • <%= t("ui.result.completion_label") %>: <strong><%= completion_mode %></strong>
  </p>
</header>

<section>
  <% @items.each do |item| %>
    <% question = item.question %>
    <% answer_state = if item.selected_key.present?
                        item.answered_correctly? ? t("ui.result.answer_state.correct") : t("ui.result.answer_state.incorrect")
                      else
                        t("ui.result.answer_state.no_answer")
                      end %>
    <% options =
      if question.answer_mode_yes_no?
        case @exam_attempt.locale
        when "en" then [ [ "T", "Yes" ], [ "N", "No" ] ]
        when "de" then [ [ "T", "Ja" ], [ "N", "Nein" ] ]
        when "ua" then [ [ "T", "Так" ], [ "N", "Ні" ] ]
        else [ [ "T", "Tak" ], [ "N", "Nie" ] ]
        end
      else
        question.question_options.sort_by(&:position).map { |option| [ option.key, option.text_for(@exam_attempt.locale) ] }
      end %>
    <% selected_option = options.find { |key, _text| key == item.selected_key } %>
    <% correct_option = options.find { |key, _text| key == item.correct_key } %>

    <article>
      <p>
        #<%= item.position %>
        • <%= item.points_possible %> <%= t("ui.common.points_short") %>
        • <%= answer_state %>
      </p>

      <h2><%= question.stem_for(@exam_attempt.locale) %></h2>

      <%= render "media", question: question, item: item %>

      <p>
        <%= t("ui.result.your_answer_label") %>:
        <strong><%= selected_option ? "#{selected_option[0]}. #{selected_option[1]}" : t("ui.result.no_answer_short") %></strong>
        •
        <%= t("ui.result.correct_answer_label") %>:
        <strong><%= correct_option ? "#{correct_option[0]}. #{correct_option[1]}" : item.correct_key %></strong>
      </p>

      <ul class="result-options">
        <% options.each do |key, text| %>
          <% classes = [ "result-option" ] %>
          <% classes << "result-option--correct" if key == item.correct_key %>
          <% classes << "result-option--selected" if key == item.selected_key %>
          <li class="<%= classes.join(" ") %>">
            <strong><%= key %>.</strong> <%= text %>
            <% if key == item.correct_key %>
              <span class="result-option__meta"><%= t("ui.result.correct_answer_label") %></span>
            <% end %>
            <% if key == item.selected_key %>
              <span class="result-option__meta"><%= t("ui.result.your_answer_label") %></span>
            <% end %>
          </li>
        <% end %>
      </ul>
    </article>
  <% end %>
</section>

<p>
  <%= link_to t("ui.result.new_test"), root_path %>
</p>
